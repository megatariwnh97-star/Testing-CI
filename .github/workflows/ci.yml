name: CI - Automation Tests


on:
 push:
   branches:
     - main
     - master
     - develop
 pull_request:
   branches:
     - main
     - master
     - develop
 workflow_dispatch:


jobs:
 test:
   name: Run Automation Tests
   runs-on: ubuntu-latest


   strategy:
     matrix:
       suite: [smoke.xml]


   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     - name: Validate Gradle Wrapper
       uses: gradle/wrapper-validation-action@v2


     - name: Set up JDK 17
       uses: actions/setup-java@v4
       with:
         java-version: '17'
         distribution: 'temurin'
         cache: 'gradle'


     - name: Setup Chrome and ChromeDriver
       run: |
         sudo apt-get update
         sudo apt-get install -y wget unzip
        
         # Install Chrome
         wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
         sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
        
         # Get Chrome version
         CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d. -f1)
         echo "Chrome version: $CHROME_VERSION"
        
         # Download matching ChromeDriver
         CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_$CHROME_VERSION")
         echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        
         wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
         unzip -q chromedriver-linux64.zip
         sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
         sudo chmod +x /usr/local/bin/chromedriver
        
         # Verify installation
         echo "Chrome installed at: $(which google-chrome)"
         google-chrome --version
         echo "ChromeDriver installed at: $(which chromedriver)"
         chromedriver --version


     - name: Make gradlew executable
       run: chmod +x ./gradlew


     - name: Run tests with Gradle
       run: ./gradlew clean test -Psuite=${{ matrix.suite }} -Penv=staging --no-daemon --stacktrace
       env:
         GITHUB_ACTIONS: true
         CHROME_BIN: /usr/bin/google-chrome
         CHROMEDRIVER_PATH: /usr/local/bin/chromedriver


     - name: Generate Test Report
       if: always()
       run: |
         echo "Test execution completed"
         ls -la build/reports/tests/test/ || echo "No test reports found"


     - name: Upload Test Reports
       if: always()
       uses: actions/upload-artifact@v4
       with:
         name: test-reports-${{ matrix.suite }}
         path: |
           build/reports/tests/test/
           build/test-results/test/
         retention-days: 30


     - name: Upload Test Results
       if: always()
       uses: actions/upload-artifact@v4
       with:
         name: test-results-${{ matrix.suite }}
         path: build/test-results/test/*.xml
         retention-days: 30





